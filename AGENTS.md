# AGENTS.md

## Project overview

- Tree-sitter grammar for OpenEdge ABL.

## Key paths

- `grammar.js`, `grammar/core.js`, `grammar/core/*.js`: grammar core + shared (accessors, expressions, extras, operators, statements).
- `grammar/definitions/*.js`: definition rules (procedures, functions, variables; usually most of things that start with define keyword).
- `grammar/expressions/*.js`: expression rules (available, locked, aggregate, conditional, function calls; specific expressions).
- `grammar/statements/*.js`: statements rules.
- `src/parser.c`, `src/grammar.json`, `src/node-types.json`: generated by `tree-sitter generate`.
- `src/scanner.c`: external scanner implementation.
- `test/corpus/`: tree-sitter corpus tests.
- `bindings/`: language bindings.
- `docs/abl-reference.txt`: abl language reference.

## Workflow

- Regenerate parser artifacts when `grammar.js` changes:
  - `bun run generate`
- Run tests:
  - `bun run test`
- Parse a sample file:
  - `bun run parse -- <file>`
- Build native and wasm artifacts:
  - `bun run build`
  - `bun run build:wasm`

## Conventions

- Always search for syntax details in `docs/abl-reference.txt` document during planning phase or implementing new features.
- Treat `src/parser.c`, `src/grammar.json`, and `src/node-types.json` as generated.
- Keep changes to `src/scanner.c` minimal and well-scoped, as it is hand-written C.
- Always run `bun run test` after changes and make sure they pass and they are always covered by tests.
- Keep everyting idiomatic and in-line with how should tree-sitter grammar parser be done, consult official `tree-sitter` documentation.
- When `generate` reports conflicts, _always_ prefer fixing it without resorting to adding a conflict and if it's mandatory first ask for confirmation.
- _Never_ add priority for keywords like it's done in the original legacy parser, solve it how it should be solved idiomatically unless it's necessary to add one.
- Prefer `kw` (requires whitespace after the keyword), `tkw` (does not require whitespace, to use in-place of `token(/keyword/i), `op` function whenever dealing with keywords.
- Do _NOT_ try to implement keywords as external scanner tokens that match case-insensitively with non-identifier character boundaries.
- Always check for `(ERROR)` or `(MISSING)` nodes in the test output and treat them as errors that need to be fixed.
- Use compact rule formatting: keep one-line rules adjacent with no blank lines between them. Only insert a blank line before/after multi-line rules (rules that wrap to multiple lines). Avoid blank lines between consecutive one-line rules.
- For every statement make a file in `grammar/statements/*.js` and `test/copus/statements/*.txt`, do not store specific statement implementations in `grammar/statements.js`.
- Avoid writing common code if it's not really a part of core syntax as we are "duplicating" modifiers/tunings for statements because we want most of the context related to the statement to be in the same file hence there are `__<statement>_rules` that get aliased to `$.rule` then later.
- Always add extensive tests when implementing new statements/expressions, try to copy the examples from `docs/abl-reference.txt`.

## Notes

- We use `bun` here instead of `npm`.
- The project uses the tree-sitter CLI; ensure it is installed via devDependencies (`tree-sitter-cli`).
