# AGENTS.md

## Project overview

- Tree-sitter grammar for OpenEdge ABL.

## Key paths

- `grammar.js`: core grammar rules.
- `grammar/core/{expressions,statements}.js`: core aggregation rules ($.\_statement, $.\_expression; mostly plumbing).
- `grammar/{expressions, statements}/index.js`: aggregator files that collect and re-export all rules from their respective categories.
- `grammar/expressions/*.js`: expression rules (available, locked, aggregate, conditional; specific expressions).
- `grammar/statements/*.js`: statements rules.
- `src/parser.c`, `src/grammar.json`, `src/node-types.json`: generated by `tree-sitter generate`.
- `src/scanner.c`: external scanner implementation.
- `test/corpus/`: tree-sitter corpus tests.
- `bindings/`: language bindings.

## Workflow

- Regenerate parser artifacts when `grammar.js` changes:
  - `bun run generate`
- Run tests (runs generate before tests):
  - `bun run test`
- Parse a sample file (returns syntax tree; `tree-sitter test`):
  - `bun run parse <file>`
  - Example: `bun run parse example.p`
- Parse a snippet (returns syntax tree):
  - `bun run parse:snippet <direct syntax string>`
  - Example: `bun run parse:snippet 'a = b + c.'`
- Build native and wasm artifacts:
  - `bun run build`
  - `bun run build:wasm`
- Check global state count:
  - `bun run check`
- Prints report with state count cost for every statement:
  - `bun run check:statements`

Strongly prefer using defined workflow commands to as they have helpful side-effects like returning `STATE_COUNT` after success.


## Conventions

- Treat `grammar.js` as core grammar rules and anything inside is "core".
- Treat `src/parser.c`, `src/grammar.json`, and `src/node-types.json` as generated.
- Avoid placing shared or generic code unless it is part of the core syntax. We intentionally duplicate modifiers and tunings at the statement level so that most of the statement-specific context lives in a single file. To support this, each statement defines its own `__<statement>_rules`, which are later aliased to `$.rule` where needed. This intentional duplication favors locality, readability, and conflict isolation over DRY abstractions.
- Always run tests after changes and make sure they pass.
- Conflicts must be resolved structurally whenever possible. Adding a `conflicts` entry is a last resort and requires prior confirmation with a clear explanation of why structural fixes are insufficient.
- When modyfing core grammar rules first ask for a confirmation unless experimenting.
- Your first solution should _never_ be to try to add a precedence to keywords, if it's necessary give me an explanation and ask for a confirmation.
- Prefer `kw` (requires whitespace after the keyword) and `tkw` (does not require whitespace) to use in-place of `token(/keyword/i)` function whenever dealing with keywords.
- Do _NOT_ try to implement keywords as external scanner tokens that match case-insensitively with non-identifier character boundaries.
- Always check for `(ERROR)` or `(MISSING)` nodes in the test output and treat them as errors that need to be fixed.
- Use compact rule formatting: keep one-line rules adjacent with no blank lines between them. Only insert a blank line before/after multi-line rules (rules that wrap to multiple lines). Avoid blank lines between consecutive one-line rules.
- Most statements/expressions should have a dedicated file in its appropriate location, for example: `grammar/statements/<statement>.js` and `test/corpus/statements/<statement>.txt` for its test cases. Statements are not considered complete without both.
- Any new or modified syntax must be accompanied by extensive tests in `test/corpus`. Grammar changes without thorough corpus coverage are unacceptable, as tests are required to validate correctness, edge cases, and future regressions.
- The grammar should avoid permissive or catch-all rules that allow invalid syntax to be parsed successfully.
- ABL grammar is filled with optionals, be careful not to explode `tree-sitter`'s `STATE_COUNT`.
- Always check `STATE_COUNT` impacts and note the current `STATE_COUNT` cost for statements via leading comments in `grammar/core/statements.js`.
- Do not remove tests just to satisfy test passing, just fix the underlying issue.
- Remember to regenerate parser after `src/scanner.c` modifications before testing.

## Notes

- We use `bun` here instead of `npm`.
- Successful tests print out current `STATE_COUNT` at the end.
- Parser does not build after reaching the hard limit of 65,535 `STATE_COUNT` but bugs might occur at the top-end of the limit e.g `tree-sitter test` might return status `0` but produce no output at about ~63,000 `STATE_COUNT`.
