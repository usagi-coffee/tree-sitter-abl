# AGENTS.md

## Project

- Tree-sitter grammar for OpenEdge ABL.

## Key paths

- `grammar.js`: core grammar rules.
- `grammar/core/{expressions,statements}.js`: core aggregation rules ($.\_statement, $.\_expression; mostly plumbing).
- `grammar/{expressions, statements, phrases, precedences}/index.js`: aggregator files that collect and re-export from their respective categories.
- `grammar/precedences/*.js`: precedences definitions
- `grammar/expressions/*.js`: expression rules (available, locked, aggregate, conditional; non-core/non-shared specific expressions).
- `grammar/statements/*.js`: statements rules (`bun run reference '*statement'`).
- `grammar/phrases/*.js`: phrases rules (`bun run reference '*phrase'`).
- `src/scanner.c`: external scanner implementation.
- `src/parser.c`, `src/grammar.json`, `src/node-types.json`: generated by `tree-sitter generate`.
- `test/corpus/`: tree-sitter corpus tests.
- `bindings/`: language bindings.

## Workflow

- Run tests:
  - `bun run test`
- Run a specific test:
  - `bun run test --include 'TEST NAME'`
  - Example: `bun run test --include 'WORKFILE DEFINITION - Shared/Private variants'`
- Parse a file:
  - `bun run parse <file>`
  - Example: `bun run parse example.p`
- Parse a snippet:
  - `bun run parse:snippet <direct syntax string>`
  - Example: `bun run parse:snippet 'a = b + c.'`
- Build native and wasm artifacts:
  - `bun run build` -> abl.so
  - `bun run build:wasm` -> tree-sitter-abl.wasm
- Prints global state count:
  - `bun run check`
- Retrieve syntax information from the language reference
  - `bun run reference <phrase from contents>`
  - Example: `bun run reference 'DEFINE VARIABLE statement'`: Returns complete reference for the define variable statement.
  - Example: `bun run reference 'DEFINE*'`: Returns all possible DEFINE entries by suffix (names only).
  - Example: `bun run reference '*statement'`: Returns all statements entries by prefix (names only).
  - Example: `bun run reference '*statement*'`: Returns all statements entries that include `statement` (names only).
  - Example: `bun run reference '*'`: Returns all entries in reference (names only).

Strongly prefer using these commands as they have helpful side-effects like returning `ACTION_COUNT`, `STATE_COUNT` and `LARGE_STATE_COUNT`.

## Conventions

- Always run tests after modifications.
- Do not remove tests unless it is illegal syntax.
- Before working on a statement, first consult its reference to ensure you understand the available syntax and it's proper usage.
- Grammar changes without thorough corpus coverage and testing are unacceptable.
- Avoid creating a shared or generic code unless it is really a part of the core syntax, core grammar modifications require a confirmation unless experimenting.
- Always prefere adding to `precedences` over using `prec(`.
- We intentionally duplicate modifiers and tunings at the statement level so that most of the statement-specific context lives in a single file. To support this, each statement defines its own `__<statement>_rules`, which are later aliased to `$.rule` where needed. This intentional duplication favors locality, readability, and conflict isolation over DRY abstractions.
- All statement-related modifiers, phrases, tunings that are not already part of core should be locally defined as `__<statement>_<rule>` rule and aliased to `$.<rule>`.
- When resolving conflicts treat adding a `conflicts` entry as a last resort that requires prior confirmation with a clear explanation of why structural fixes are insufficient.
- Prefer `kw` for keywords in place of `token(/keyword/i)`, when the syntax supports partial keyword like `DEFINE` can be `DEF`, `DEFI`, `DEFIN` and `DEFINE` please use `kw("DEFINE", { offset: 3 })`, for scenario where it can be longer do alias e.g`kw("FIELDS", { alias: 'FIELD', offset: 5)`.
- Treat `(ERROR)` and `(MISSING)` nodes in the test output aserrors that need to be fixed.
- Use compact rule formatting: keep one-line rules adjacent with no blank lines, avoid blank lines between consecutive one-line rules.
- The grammar should avoid permissive or catch-all rules that allow invalid syntax to be parsed successfully.
- ABL grammar is filled with optionals, be careful not to explode `tree-sitter`'s `ACTION_COUNT`, `STATE_COUNT` and `LARGE_STATE_COUNT` always check modification's impact on these.
- When weighing the impact of the modifications on `ACTION_COUNT`, `LARGE_STATE_COUNT` and `STATE_COUNT` prefer biggest reductions to `ACTION_COUNT` but don't treat it as absolute, if `ACTION_COUNT` goes up by a small amount but `LARGE_STATE_COUNT` goes down by a few hundred then keep the changes anyway.
- Do not adjust or remove tests just to satisfy test passing, just fix the underlying parsing issue or ask me first to remove if it's really not supported.
- Don't do unnecessary comments like `// something is above`.
- Never add `(ERROR` nodes to expected syntax trees in tests, it's pointless, fix the grammar not the test itself.
- Prefer not using `_list` suffix for rules e.g `_format_label_list` should be `_format_labels`.
- Prefer precedences over `prec(...)`.
- Avoid hacks like cramming `FRAME` into regex to avoid the issue.
- Add purpose + example comments before each precedence group when modifying precedences; add reference notes for each precedence entry.
- If needed, refactor rules to be easier to target in precedence (e.g you can't target repeat(some_rule), its fine to refactor into e.g `__statement_expression: ($) => $._expression`.
- Any newly added grammar warrants adding a tests for it, please write tests for new grammar constructs.

## Notes

- `bun` instead of `npm`.
- Never use `tree-sitter` CLI directly, use workflow commands.
- There is no need to call `bun run build` during testing workflow, just use usual workflow commands like `bun run test` and `bun run parse:snippet`, they build/generate under the hood.
- Parser generation can take up to 1 minute so adjust timeout accordingly.
- `bun run test` returns only failed cases and failed syntax tree OR a message that everything went well.
- When using `alias`, `tree-sitter` handles undefined rules by using the property name as the symbol name so it's okay to alias to `$.something_that_wasn't defined`.
- `terminator`, `terminator_dot` or rules prefixed with `_` (unless aliased) should never be visible in the syntax tree output.
- Always prefer `| head` when calling `bun run test` instead of `| tail`.
- The `Permission denied (os error 13)` error occurs because the sandbox blocks writing outside the workspace, preventing tree-sitter from creating its lock file in the user's cache directory.
- When receiving a conflict error trust keyword tokens in {â€¦}; ignore deduplicated rule names like __browse_body_token7.
