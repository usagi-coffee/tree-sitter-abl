# AGENTS.md

## Project overview

- Tree-sitter grammar for OpenEdge ABL.

## Key paths

- `grammar.js` and `grammar/core/{accessors,definitions,expressions,extras,operators,statements}.js`: core grammar rules.
- `grammar/definitions/*.js`: definition rules (procedures, functions, variables; usually most of things that start with define keyword).
- `grammar/{definitions, expressions, statements}/index.js`: aggregator files that collect and re-export all rules from their respective categories.
- `grammar/expressions/*.js`: expression rules (available, locked, aggregate, conditional, function calls; specific expressions).
- `grammar/statements/*.js`: statements rules.
- `src/parser.c`, `src/grammar.json`, `src/node-types.json`: generated by `tree-sitter generate`.
- `src/scanner.c`: external scanner implementation.
- `test/corpus/`: tree-sitter corpus tests.
- `bindings/`: language bindings.
- `docs/abl-reference.txt`: abl language reference.
- `docs/tree-sitter.txt`: tree-sitter documentation.

## Workflow

- Regenerate parser artifacts when `grammar.js` changes:
  - `bun run generate`
- Run tests:
  - `bun run test`
- Parse a sample file:
  - `bun run parse -- <file>`
  - `bun run parse:snippet -- <direct syntax>`
- Build native and wasm artifacts:
  - `bun run build`
  - `bun run build:wasm`

## Conventions

- Treat `grammar.js` as core grammar rules and anything inside is "core".
- Treat `src/parser.c`, `src/grammar.json`, and `src/node-types.json` as generated.
- Always consult `docs/abl-reference.txt` when planning, modifying, or extending syntax support. Any work related to grammar, parsing behavior, or syntax improvements must be grounded in the reference documentation to ensure correctness, completeness, and alignment with the language specification.
- Avoid placing shared or generic code unless it is part of the core syntax. We intentionally duplicate modifiers and tunings at the statement level so that most of the statement-specific context lives in a single file. To support this, each statement defines its own `__<statement>_rules`, which are later aliased to `$.rule` where needed. This intentional duplication favors locality, readability, and conflict isolation over DRY abstractions.
- Avoid doing changes to `src/scanner.c` unless it's necessary and cleanest way to solve the problem.
- Always run tests after changes and make sure they pass.
- Conflicts must be resolved structurally whenever possible. Adding a `conflicts` entry is a last resort and requires prior confirmation with a clear explanation of why structural fixes are insufficient.
- When drive-by modyfing core grammar rules first ask for a confirmation.
- Your first solution should _never_ be to try to add a precedence to keywords, if it's necessary give me an explanation and ask for a confirmation.
- Prefer `kw` (requires whitespace after the keyword) and `tkw` (does not require whitespace) to use in-place of `token(/keyword/i)` function whenever dealing with keywords.
- Do _NOT_ try to implement keywords as external scanner tokens that match case-insensitively with non-identifier character boundaries.
- Always check for `(ERROR)` or `(MISSING)` nodes in the test output and treat them as errors that need to be fixed.
- Use compact rule formatting: keep one-line rules adjacent with no blank lines between them. Only insert a blank line before/after multi-line rules (rules that wrap to multiple lines). Avoid blank lines between consecutive one-line rules.
- For every statement make a file in their respective place `grammar/statements/*.js` and `test/corpus/statements/*.txt`.
- Most definitions/statements/expressions should have a dedicated file in its appropriate location, for example: `grammar/statements/<statement>.js` and `test/corpus/statements/<statement>.txt` for its test cases. Statements are not considered complete without both.
- Any new or modified syntax must be accompanied by extensive tests in `test/corpus`. Grammar changes without thorough corpus coverage are unacceptable, as tests are required to validate correctness, edge cases, and future regressions.
- The grammar should avoid permissive or catch-all rules that allow invalid syntax to be parsed successfully.
- Write idiomatic `tree-sitter` grammar code at all times, and consult `docs/tree-sitter.txt` whenever there is uncertainty about correct or idiomatic usage.
- ABL grammar is filled with optionals, be careful no to explode `tree-sitter`'s `STATE_COUNT`, check `STATE_COUNT` after every generate/test.
- Do not remove tests just to satisfy test passing, just fix the underlying issue.

## Notes

- We use `bun` here instead of `npm`.
- `bun run test` runs `tree-sitter generate` and `tree-sitter test`, in cases where you updated the test or did not do any modifications you can directly use `tree-sitter test` instead to save time (becase nothing got regenerated).
- You can test syntax ad-hoc by invoking the parser directly, for example using `bun run parse:snippet -- 'x = 5.'` to quickly retrieve a syntax tree or validate grammar behavior on a small snippet but make sure to `generate` the parser at least once.
- You can verify `STATE_COUNT` by invoking `grep -E "#define.*STATE_COUNT" src/parser.c`.
- The project uses the `tree-sitter` CLI; ensure it is installed via devDependencies (`tree-sitter-cli`).
