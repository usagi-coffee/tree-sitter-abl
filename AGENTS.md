# AGENTS.md

## Project overview
- Tree-sitter grammar for OpenEdge ABL.
- Source grammar lives in `grammar.js`; generated artifacts live in `src/`.

## Key paths
- `grammar.js`, `grammar/**/*.js`: primary grammar source.
- `src/parser.c`, `src/grammar.json`, `src/node-types.json`: generated by `tree-sitter generate`.
- `src/scanner.c`: external scanner implementation.
- `test/corpus/`: tree-sitter corpus tests.
- `bindings/`: language bindings.
- `docs/abl-reference.txt`: abl language reference.

## Syntax categories
- Core (preprocessor, comments, includes, constants, object accesses, identifiers, literals, etc)
- Operators (logicals, assignments, etc)
- Definitions (DEFINE statements)
- Widgets (all UI-related statements and constructs)
- Statements (blocks, loops, find, for loops, all non ui-related statements, etc)
- Classes (self-explanatory)

## Workflow
- Regenerate parser artifacts when `grammar.js` changes:
  - `bun run generate`
- Run tests:
  - `bun run test`
- Parse a sample file:
  - `bun run parse -- <file>`
- Build native and wasm artifacts:
  - `bun run build`
  - `bun run build:wasm`

## Conventions
- Always search in `docs/abl-reference.pdf` document before implementing a new syntax.
- Treat `src/parser.c`, `src/grammar.json`, and `src/node-types.json` as generated; edit `grammar.js` and `scanner.c` (if needed) instead.
- Keep changes to `src/scanner.c` minimal and well-scoped, as it is hand-written C.
- Always run `bun run test` after changes and make sure they pass and they are always covered by tests.
- Keep everyting idiomatic and in-line with how should tree-sitter grammar parser be done, consult official `tree-sitter` documentation.
- When `generate` reports conflicts, *always* prefer fixing it without resorting to conflict and if it's mandatory first ask for confirmation.
- *Never* add priority for keywords like it's done in the original legacy parser, solve it how it should be solved idiomatically
- Please place functions and write tests into correct files.
- Always prefer to inline keywords to `kw("SOME-KW")` instead of doing `some_keyword` node unless necessary to, and if necessary first ask for confirmation.
- Do *NOT* try to implement keywords as external scanner tokens that match case-insensitively with non-identifier character boundaries.
- Always check for `(ERROR)` nodes in the tests nodes and treat them as errors than need to be fixed.
- Keep the nodes clean, for example if you are going to do two nodes like `binary_expression_no_eq` and `binary_expression` alias it to `binary_expression` if it's theoretically compatible.
- Use compact rule formatting: keep one-line rules adjacent with no blank lines between them. Only insert a blank line before/after multi-line rules (rules that wrap to multiple lines). Avoid blank lines between consecutive one-line rules.
- For every statement make a file in grammar/statements/<statement>.js and test/copus/statements<statement>.txt, do not store specific statement implementations in grammar/statements.js
- We are "duplicating" modifiers/tunings for statements because we want most of the context related to the statement to be in the same file hence there are `__<statement>_rules` that get aliased to `$.rule` then later.
- When you use `token(/word/i)` prefer using `tkw()` function instead if applicable.

## Notes
- We use `bun` here instead of `npm`.
- The project uses the tree-sitter CLI; ensure it is installed via devDependencies (`tree-sitter-cli`).
